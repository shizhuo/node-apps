<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
</head>
<body ng-app='app' ng-controller='appCtrl'>
<input type='text' value='' ng-model='msg'>
<button ng-click='postmsg()'>OK</button>
<div class='results'>

</div>
<script type="text/javascript" src='../bower_components/jquery/dist/jquery.js'></script>
<script type='text/javascript' src='../bower_components/angular/angular.js'></script>

<script>
var ajaxurl = 'ajax';
var app = angular.module('app', []); 

app.controller('appCtrl', ['$scope', '$http', function($scope, $http){
	$scope.msg = 'msg posted'; 
	$scope.uid; 
	$scope.postmsg = function(){
		$http({
			url: 'ajax', 
			method: 'GET',
			params: {
				action: 'post', 
				msg: $scope.msg, 
				uid: $scope.uid
			}
		}).success(function(response){
			//$(".results").append(response + '<br>'); 
		}); 
	};

	$scope.uid = get_query()['uid']; 
	
	if (!!window.EventSource){		
		$scope.source = new EventSource('/events?uid=' + $scope.uid);
		//on message
		$scope.source.addEventListener('message', function(e) {
			var data = JSON.parse(e.data); 
			for (var i = 0; i < data.length; i++){ 
				//console.log(data); 
				var who = data[i].uid; 
				var when = data[i].time; 
				var what = data[i].msg;
				var msg =  who + '(' + when + '): ' + what + "<br>";
				console.log(msg);  
				$(".results").append(msg); 
			}
		}, false);
		 

	}else {

	}	

	$(window).on('beforeunload', function(){
		//$scope.source.close(); 
		//return 'close';  
	}); 

}]);

function get_query(){
	var query = {}; 
	var str = window.location.search.substring(1); 
	var vars = str.split('&'); 
	for (var i = 0; i < vars.length; i++){
		var pair = vars[i].split('='); 
		query[pair[0]] = pair[1]; 
	}
	console.log(query);
	return query; 
}

$(document).ready(function(){
})



</script>
</body>
</html>
